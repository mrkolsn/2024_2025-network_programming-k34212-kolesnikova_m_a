University: [ITMO University](https://itmo.ru/ru/)

Faculty: [FICT](https://fict.itmo.ru)

Course: [Network programming](https://github.com/itmo-ict-faculty/network-programming)

Year: 2024/2025

Group: K34212

Author: Kolesnikova Maria Alexeevna

Lab: Lab4

Date of create: 09.01.2025

Date of finished: 12.01.2025

# Лабораторная работа №4 "Базовая 'коммутация' и туннелирование используя язык программирования P4"

## Цель работы
Изучить синтаксис языка программирования P4 и выполнить 2 задания обучающих задания от Open network foundation для ознакомления на практике с P4.

## Ход работы
Был скачан образ виртуальной машины P4 Tutorial, далее образ был импортирован через импорт конфигураций в VirtualBox

![Снимок экрана 2025-01-13 000102](https://github.com/user-attachments/assets/b14d3f85-2077-4f83-a849-eb5797f3cc7d)


### Реализация базовой переадресации
1. В полученной виртуальной машине после перехода в директорию ```tutorials/exercices/basic``` была выполнена команда ```make run``` для поднятия Mininet

![Снимок экрана 2025-01-13 001134](https://github.com/user-attachments/assets/9a6d179f-faf1-4dd0-b597-d2573cb079cb)


2. Выполнение команды ```pingall``` демонстрирует, что коммутаторы отбрасывают все входящие пакеты

![Снимок экрана 2025-01-13 001331](https://github.com/user-attachments/assets/09a98f64-89a5-4283-a150-87b51eaee077)


3. Чтобы это исправить, нужно внести изменения в файл конфигурации basic.p4

  * Добавим логику парсинга для пакетов ethernet и ipv4:

![Снимок экрана 2025-01-13 004232](https://github.com/user-attachments/assets/06b48384-b34c-41ec-bc6f-aee3a52d42f3)


  * В разделе INGRESS PROCESSING нужно дополнить логику пересылки пакетов для действия ```ipv4_forward```, а также добавить проверку на валидность IPv4 заголовков

![Снимок экрана 2025-01-13 004058](https://github.com/user-attachments/assets/079169c2-3c18-483d-977d-d29108123c76)


  * В секции DEPARSER добавить функцию для вставки заголовков в исходящие пакеты

![Снимок экрана 2025-01-13 003925](https://github.com/user-attachments/assets/349371e7-20b7-4288-a424-0dddfc170324)


4. Успешное выполнение команды ```pingall``` после сохранения всех изменений в файле и повторного запуска Mininet:

![Снимок экрана 2025-01-13 004811](https://github.com/user-attachments/assets/e85a42a0-da11-4011-b204-13e799ba2ac2)


### Реализация базового туннелирования
1. Для реализации базового туннелирования нужно перейти в директорию ```tutorials/exercices/basic_tunnel/``` и внести изменения в файл ```basic_tunnel.p4```.


2. Файл был дополнен следующим образом:

  * В секции PARSER требуется описать логику обработки заголовков myTunnel

![Снимок экрана 2025-01-13 011458](https://github.com/user-attachments/assets/d5be33f0-e361-4378-9077-29b3f2bfc005)


  * В секции INGRESS PROCESSING нужно объявить новое действие myTunnel_forward и новую таблицу myTunnel_exact, а также добавить применение таблицы в секции apply

![Снимок экрана 2025-01-13 012028](https://github.com/user-attachments/assets/0b8accf4-694b-4b58-a4cf-05a6292d1a75)


  * В секции DEPARSER также нужно добавить логику обработки для исходящих пакетов туннелирования

![Снимок экрана 2025-01-13 012111](https://github.com/user-attachments/assets/1546b8cc-6617-4157-9dde-3bbbb9872366)


3. Проверка корректности работы повторно поднятого Mininet:

* В терминале коммутатора H1 был запущен сервер ```./receive.py```, после чего в терминале H2 была выполнена команда ```./send.py 10.0.1.1 "hello world"```. Отправка сообщения без туннелирования прошла успешно

![Снимок экрана 2025-01-13 012437](https://github.com/user-attachments/assets/d653b16a-c843-4f69-8357-abd4a001f426)


* Для проверки работы туннелирования на H2 была выполнена команда ```./send.py 10.0.1.1 "hello world" --dst_ip 1```. У полученного пакета есть заголовок MyTunnel

![Снимок экрана 2025-01-13 012510](https://github.com/user-attachments/assets/0c66f262-a07a-45e4-b8cc-4932b38e3e0e)


* При выполнении команды  ```./send.py 10.0.3.3 "hello world" --dst_ip 1``` сообщение будет получено первым коммутатором, несмотря на то, что указан IP-адрес третьего. Это объясняется тем, что при наличии заголовка MyTunnel в пакете именно он используется для маршрутизации, а не IP-заголовок

![Снимок экрана 2025-01-13 012520](https://github.com/user-attachments/assets/00178384-8117-4ecb-bcaf-f44a6454adff)


## Результат

В ходе данной работы были реализованы базовая переадресация и туннелирование с помощью языка P4
